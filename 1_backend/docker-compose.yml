
services:
  mongodb:
    image: mongo:7.0
    container_name: tosyam-mongodb
    restart: unless-stopped
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    environment:
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-tosyam}
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USERNAME:-}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD:-}
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - tosyam-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: tosyam-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    command: >
      sh -c "redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru $${REDIS_PASSWORD:+--requirepass $$REDIS_PASSWORD}"
    healthcheck:
      test: ["CMD-SHELL", "redis-cli $${REDIS_PASSWORD:+-a $$REDIS_PASSWORD} ping || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - tosyam-network
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}

  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tosyam-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-3000}:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${BACKEND_PORT:-3000}
      - JWT_SECRET=${JWT_SECRET}
      - MONGODB_USERNAME=${MONGODB_USERNAME:-}
      - MONGODB_PASSWORD=${MONGODB_PASSWORD:-}
      - MONGODB_DATABASE=${MONGODB_DATABASE:-tosyam}
      - MONGODB_URI=${MONGODB_URI:-mongodb://${MONGODB_USERNAME:+${MONGODB_USERNAME}${MONGODB_PASSWORD:+:${MONGODB_PASSWORD}}@}mongodb:27017/${MONGODB_DATABASE:-tosyam}${MONGODB_USERNAME:+?authSource=admin}}
      - REDIS_URL=${REDIS_URL:-redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379}
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - tosyam-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  redis-data:
    driver: local

networks:
  tosyam-network:
    driver: bridge

